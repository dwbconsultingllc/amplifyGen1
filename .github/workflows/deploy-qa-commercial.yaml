name: Deploy to QA (Commercial) only.

on:
  pull_request:
    branches:
      - qa
  push:
    branches:
      - qa

# Todo:
# Update permissions for the role this workflow assumes
# Test frontend deployment
# Deploy backend resources

# Amplify pull issue.
# deal with charage returns.
# deal with directory names getting renamed.

jobs:
  QA-Publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    environment: qa
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::350141380063:role/Github-repo-amplifygen1
          aws-region: us-west-2

      - name: Install AWS Amplify CLI
        run: npm i -g @aws-amplify/cli

      - name: Pull Amplify environment
        run: |
          # Pull the latest changes from the Amplify environment
          amplify pull --yes \
          --amplify "{\"envName\":\"qa\",\"appId\":\"d2gkl3jbi17ke1\"}" \
          --providers "{\"awscloudformation\":{\"configLevel\":\"general\",\"useProfile\":false,\"accessKeyId\":\"$AWS_ACCESS_KEY_ID\",\"secretAccessKey\":\"$AWS_SECRET_ACCESS_KEY\",\"region\":\"$AWS_REGION\"}}"

          diff -r amplify/\#current-cloud-backend amplify/backend --exclude="amplify-meta.json" || echo "CloudFormation changes detected."

      - name: Git reset.
        run: |
          # Reset the changes made by amplify pull.
          git reset --hard HEAD 
          # Check for changes to the backend.
          diff -r amplify/\#current-cloud-backend amplify/backend --exclude="amplify-meta.json" || echo "CloudFormation changes detected."

      - name: Deploy to QA (Only on Push)
        if: github.event_name == 'push' && github.ref == 'refs/heads/qa'
        run: |
          echo "Deploying backend/frontend to QA using downloaded artifact..."
          npm ci
          amplify publish --yes --force
